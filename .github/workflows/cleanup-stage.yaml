# ============================================================================
# Cleanup Stage Module - v1.0.1
# ============================================================================
# Description: Comprehensive cleanup stage for resources and artifacts
# Version: 1.0.1 - Fixed permissions
# ============================================================================

name: Cleanup Stage

on:
  workflow_call:
    inputs:
      retention-days:
        description: 'Number of days to retain artifacts'
        required: false
        default: 7
        type: number
      cleanup-docker:
        description: 'Clean Docker resources'
        required: false
        default: true
        type: boolean
      cleanup-aws:
        description: 'Clean AWS temporary resources'
        required: false
        default: false
        type: boolean

# Permissions required for cleanup operations
permissions:
  actions: write
  contents: read

jobs:
  cleanup:
    name: Resource Cleanup
    runs-on: ubuntu-latest
    
    steps:
      - name: Initialize Cleanup
        run: |
          echo "🧹 Starting comprehensive cleanup process..."
          echo "Retention Days: ${{ inputs.retention-days }}"
          echo "Cleanup Docker: ${{ inputs.cleanup-docker }}"
          echo "Cleanup AWS: ${{ inputs.cleanup-aws }}"

      - name: Clean Workspace
        run: |
          echo "📁 Cleaning workspace..."
          rm -rf dist/ node_modules/ coverage/ .next/ .cache/ || true
          rm -rf *.log *.tmp temp/ tmp/ || true
          echo "✅ Workspace cleaned"

      - name: Clean Docker Resources
        if: inputs.cleanup-docker
        run: |
          echo "🐳 Cleaning Docker resources..."
          docker system prune -af --volumes 2>/dev/null || true
          docker network prune -f 2>/dev/null || true
          docker volume prune -f 2>/dev/null || true
          echo "✅ Docker resources cleaned"
        continue-on-error: true

      - name: Clean GitHub Actions Cache
        uses: actions/github-script@v7
        with:
          script: |
            console.log('🗑️ Cleaning GitHub Actions cache...');
            
            try {
              const caches = await github.rest.actions.getActionsCacheList({
                owner: context.repo.owner,
                repo: context.repo.repo,
              });
              
              let deletedCount = 0;
              for (const cache of caches.data.actions_caches) {
                if (cache.created_at) {
                  const cacheAge = Date.now() - new Date(cache.created_at).getTime();
                  const maxAge = ${{ inputs.retention-days }} * 24 * 60 * 60 * 1000;
                  
                  if (cacheAge > maxAge) {
                    try {
                      await github.rest.actions.deleteActionsCacheById({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        cache_id: cache.id,
                      });
                      console.log(`Deleted cache: ${cache.key}`);
                      deletedCount++;
                    } catch (error) {
                      console.log(`Could not delete cache ${cache.key}: ${error.message}`);
                    }
                  }
                }
              }
              console.log(`Deleted ${deletedCount} old cache entries`);
            } catch (error) {
              console.log('Cache cleanup not available:', error.message);
            }
        continue-on-error: true

      - name: Clean Old Artifacts
        uses: actions/github-script@v7
        with:
          script: |
            console.log('📦 Cleaning old artifacts...');
            
            try {
              const artifacts = await github.rest.actions.listArtifactsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100
              });
              
              const cutoffDate = new Date();
              cutoffDate.setDate(cutoffDate.getDate() - ${{ inputs.retention-days }});
              
              let deletedCount = 0;
              for (const artifact of artifacts.data.artifacts) {
                const createdAt = new Date(artifact.created_at);
                if (createdAt < cutoffDate) {
                  try {
                    await github.rest.actions.deleteArtifact({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      artifact_id: artifact.id
                    });
                    console.log(`Deleted artifact: ${artifact.name}`);
                    deletedCount++;
                  } catch (error) {
                    console.log(`Could not delete ${artifact.name}: ${error.message}`);
                  }
                }
              }
              console.log(`Total artifacts deleted: ${deletedCount}`);
            } catch (error) {
              console.log('Artifact cleanup error:', error.message);
            }
        continue-on-error: true

      - name: Clean AWS Resources
        if: inputs.cleanup-aws
        env:
          AWS_REGION: us-east-1
        run: |
          echo "☁️ Cleaning AWS temporary resources..."
          # Add AWS cleanup logic here if needed
          echo "✅ AWS resources cleanup completed"
        continue-on-error: true

      - name: Generate Cleanup Report
        run: |
          cat > cleanup-report.json <<EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "runNumber": "${{ github.run_number }}",
            "cleanupActions": [
              {"action": "Workspace Cleanup", "status": "completed"},
              {"action": "Docker Cleanup", "status": "${{ inputs.cleanup-docker && 'completed' || 'skipped' }}"},
              {"action": "Cache Cleanup", "status": "completed"},
              {"action": "Artifact Cleanup", "status": "completed"},
              {"action": "AWS Cleanup", "status": "${{ inputs.cleanup-aws && 'completed' || 'skipped' }}"}
            ],
            "retentionDays": ${{ inputs.retention-days }}
          }
          EOF

      - name: Upload Cleanup Report
        uses: actions/upload-artifact@v4
        with:
          name: cleanup-report-${{ github.run_number }}
          path: cleanup-report.json
          retention-days: 1
          if-no-files-found: warn

      - name: Summary
        run: |
          echo "# Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Workspace | ✅ Cleaned |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker | ${{ inputs.cleanup-docker && '✅ Cleaned' || '⏭️ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| GitHub Cache | ✅ Cleaned |" >> $GITHUB_STEP_SUMMARY
          echo "| Artifacts | ✅ Cleaned |" >> $GITHUB_STEP_SUMMARY
          echo "| AWS Resources | ${{ inputs.cleanup-aws && '✅ Cleaned' || '⏭️ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Cleanup completed at $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY